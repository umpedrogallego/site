<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedro Gallego</title>
    <link href="https://fonts.googleapis.com/css2?family=Martian+Mono:wght@100;300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #ecece9;
            --text: #0f0f0f;
            --border: #d1d1cf;
        }

        body {
            font-family: 'Martian Mono', monospace;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            font-size: 13px;
        }

        /* Header sempre em MAIÚSCULO */
        header {
            padding: 40px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            text-transform: uppercase;
        }

        header h1 { font-weight: 500; font-size: 24px; margin: 0; letter-spacing: -1.38px; }

        /* Grid Principal */
        #main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 0;
        }

        .item-obra {
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            padding: 20px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .item-obra:hover { background: #e2e2df; }

        .img-thumb {
            width: 100%;
            aspect-ratio: 1 / 1;
            background: #dadada;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .img-thumb img { width: 100%; height: 100%; object-fit: cover; }

        .info-resumida { font-weight: 300; text-transform: none; }
        .info-resumida strong { font-weight: 600; }

        /* Painel de Expansão (Carrossel) */
        .detalhe-expansao {
            grid-column: 1 / -1; /* Ocupa a linha toda */
            background: #f5f5f3;
            border-bottom: 1px solid var(--border);
            display: none; /* Escondido por padrão */
            padding: 40px;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .carrossel {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding-bottom: 20px;
            margin-bottom: 30px;
            scrollbar-width: thin;
        }

        .carrossel img {
            height: 400px; /* Altura fixa para manter o alinhamento */
            width: auto;
            object-fit: contain; /* NUNCA CROPADO */
            background: #eee;
        }

        .ficha-completa {
            max-width: 800px;
            text-transform: none; /* Garante que não use uppercase */
            line-height: 1.6;
        }

        .btn-sobre {
            background: none;
            border: 1px solid var(--text);
            padding: 5px 10px;
            font-family: inherit;
            font-size: 11px;
            cursor: pointer;
            margin-top: 15px;
        }

        .texto-sobre {
            margin-top: 15px;
            display: none;
            font-size: 12px;
            color: #555;
            border-top: 1px dashed var(--border);
            padding-top: 15px;
        }

        /* Utilitários */
        .show { display: block !important; }

        @media (max-width: 600px) {
            #main-grid { grid-template-columns: 1fr; }
            .carrossel img { height: 250px; }
        }
    </style>
</head>
<body>

<header>
    <h1>Pedro Gallego</h1>
    <div>obras / cv / info</div>
</header>

<main id="main-grid"></main>

<div id="painel-detalhe" class="detalhe-expansao">
    <div class="carrossel" id="carrossel-imgs"></div>
    <div class="ficha-completa" id="ficha-texto"></div>
    <div id="container-sobre"></div>
</div>

<script>
const imgBase = "https://raw.githubusercontent.com/umpedrogallego/site/main/img/";
let data = [];

// Função para buscar o JSON do seu GitHub
async function carregarDados() {
    const url = "https://raw.githubusercontent.com/umpedrogallego/site/main/json/trabalhos.json";
    try {
        const res = await fetch(url);
        data = await res.json();
        renderGrid();
    } catch (e) { console.error("Erro ao carregar JSON", e); }
}

function formatarData(o) {
    if (!o.FIM) return o.ANO;
    return o.FIM === "-" ? `${o.ANO}-` : `${o.ANO}-${o.FIM}`;
}

function gerarFichaTecnica(o) {
    let f = `<strong>${o.TITULO}</strong>, ${formatarData(o)}`;
    if (o.SERIE) f += `, série ${o.SERIE}`;
    f += `.`;
    
    let corpo = [];
    if (o.TECNICA) corpo.push(o.TECNICA);
    if (o.DIMENSAO) corpo.push(o.DIMENSAO);
    if (corpo.length > 0) f += ` ${corpo.join(", ")}.`;
    
    if (o.EDIÇÃO) f += ` ${o.EDIÇÃO}.`;
    if (o.PARCERIA) f += ` em parceria com ${o.PARCERIA}.`;
    
    return f;
}

function renderGrid() {
    const grid = document.getElementById('main-grid');
    
    const sorted = data.sort((a,b) => (a.DESTAQUE || 999) - (b.DESTAQUE || 999) || b.ANO - a.ANO);

    grid.innerHTML = sorted.map((obra, i) => `
        <div class="item-obra" onclick="abrirDetalhe(this, ${i})">
            <div class="img-thumb">
                <img src="${imgBase}${obra.ID}a.jpg" onerror="this.src='${imgBase}${obra.ID}a.avif'; this.onerror=function(){this.src='${imgBase}z-error.png'}">
            </div>
            <div class="info-resumida">
                <strong>${obra.TITULO}</strong><br>${formatarData(obra)}
            </div>
        </div>
    `).join('');
}

function abrirDetalhe(elemento, index) {
    const obra = data[index];
    const painel = document.getElementById('painel-detalhe');
    
    // Lógica para inserir o painel após a linha correta
    // No grid auto-fill, precisamos colocar o painel após o elemento clicado
    // mas o CSS grid-column: 1/-1 fará ele ocupar a linha toda abaixo.
    elemento.after(painel);
    painel.classList.add('show');

    // Montar Carrossel (Tenta letras a, b, c, d, e)
    const carrossel = document.getElementById('carrossel-imgs');
    const letras = ['a', 'b', 'c', 'd', 'e'];
    carrossel.innerHTML = letras.map(l => `
        <img src="${imgBase}${obra.ID}${l}.jpg" 
             onerror="tentarAvif(this, '${obra.ID}${l}')" 
             alt="${obra.TITULO}">
    `).join('');

    // Montar Ficha
    document.getElementById('ficha-texto').innerHTML = gerarFichaTecnica(obra);

    // Montar Sobre
    const containerSobre = document.getElementById('container-sobre');
    containerSobre.innerHTML = obra.SOBRE ? `
        <button class="btn-sobre" onclick="document.getElementById('txt-sb').classList.toggle('show')">+ sobre</button>
        <div id="txt-sb" class="texto-sobre">${obra.SOBRE}</div>
    ` : '';

    // Scroll suave para o painel
    setTimeout(() => painel.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
}

function tentarAvif(img, id) {
    if (img.src.endsWith('.jpg')) {
        img.src = `${imgBase}${id}.avif`;
    } else {
        img.remove(); // Se não tem nem jpg nem avif, remove do carrossel
    }
}

carregarDados();
</script>

</body>
</html>
